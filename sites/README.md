# Whistleblower Templates

This directory contains configuration **templates** and **local configs** for Whistleblower.

## File Types

### `.template.json` - Vendor/System Templates

These are **starting points** for different BAS vendor systems. They contain:

- Typical login selectors for that vendor
- Documentation and comments explaining the pattern
- Example watch target configurations
- Instructions for customization

**Do not use templates directly.** Copy and customize for your specific site.

### `.json` - Production Configurations

These are **active configurations** for your specific sites. They're ready to run:

- `whistleblower.py --config sites/my-site.json`
- Include actual URLs, credentials, and custom selectors
- Generated by `bootstrap_recorder.py` or manually created from a template

### `.bootstrap.json` - Recorder Output

Generated by `bootstrap_recorder.py`. These are:

- Raw recordings of your login and navigation
- Can be used as-is, or reviewed and tuned
- Should be reviewed and renamed to `.json` before use

### `.steps.json` - Navigation Steps

Generated by `bootstrap_recorder.py`. These contain:

- Suggested click/navigation steps for your site
- Can be used to build watch targets with `pre_click_steps`

---

## Quick Start

### For Known Systems (Niagara, Trane Tracer, etc.)

1. **Identify your system type** from `templates-registry.json`

2. **Copy the template**

```bash
cp sites/niagara.template.json sites/my-niagara-site.json
```

3. **Edit with your details**
   - Replace `your_niagara_host` ‚Üí your actual hostname
   - Replace `your_site_name` ‚Üí a descriptive name
   - Set credentials (env vars or inline)

4. **Test it**

```bash
python3 whistleblower.py --config sites/my-niagara-site.json
```

### For Unknown Systems

1. **Use bootstrap_recorder.py to discover selectors**

```bash
python3 bootstrap_recorder.py --url https://your-system.local --site-name my-vendor
```

2. **Review the output**
   - `sites/my-vendor.bootstrap.json` - Generated config
   - `data/bootstrap/my-vendor/` - Screenshots, DOM extracts, video

3. **Based on patterns, pick closest template or tune bootstrap config**

4. **Rename and activate**
   ```bash
   mv sites/my-vendor.bootstrap.json sites/my-vendor.json
   python3 whistleblower.py --config sites/my-vendor.json
   ```

---

## Template Characteristics

| Vendor | Template | Login Type | Tested | Notes |
| -------- | -------- | -------- | -------- | -------- |
| **Tridium** | `niagara.template.json` | 2-step multi-page | ‚úÖ | Most common BAS. Username on /prelogin, password on /login |
| **Trane** | `trane-tracer-synchrony.template.json` | Single form | ‚úÖ | Uses /hui/index.html, hash routing |
| **React/SPA** | `react-url-based.template.json` | Single form | ‚úÖ | Hash-routed navigation (most reliable) |
| **React/SPA** | `react-click-based.template.json` | Single form | ‚úÖ | Click-based nav (less reliable) |
| **Johnson Controls** | `johnson-controls.template.json` (planned) | Unknown | ‚ùå | Template planned - needs bootstrap recording |
| **Custom/Generic** | `example.json` | Flexible | ‚úÖ | Start here if not sure |

---

## Multi-Step Login (Niagara Pattern)

Niagara requires **2 separate pages** for login:

```text
Page 1: /prelogin
  Input: username
  Action: submit
  ‚Üì
Page 2: /login (browser redirects)
  Input: password
  Action: submit
  ‚Üì
Dashboard
```

**whistleblower.py has been updated** to handle this:

- Detects when only username OR password field is visible
- Fills username on page 1, submits, waits for page 2
- Fills password on page 2, submits
- Handles "force-fill" for disabled fields

---

## Creating Your Own Template

If you have a BAS system not in the registry:

1. **Run bootstrap_recorder.py**

```bash
python3 bootstrap_recorder.py \
  --url https://your-system \
  --site-name my-vendor-name \
  --ignore-https-errors
```

2. **Review the generated files**
   - `sites/my-vendor-name.bootstrap.json` - config
   - `data/bootstrap/my-vendor-name/*/` - evidence

3. **Extract key information**
   - Login selectors: `user_selector`, `pass_selector`, `submit_selector`
   - Page URLs: What pages does the recorder visit?
   - Login pattern: Single page? Multi-step? Redirects?

4. **Create template**

```json
   {
     "_meta": {
       "template_type": "my-vendor",
       "vendor": "Vendor Name",
       "system": "Product Name",
       "login_pattern": "single-step or multi-step"
     },
     "name": "your_site_name",
     "base_url": "https://your-host",
     "login": {
       "username": "${VENDOR_USERNAME}",
       "password": "${VENDOR_PASSWORD}",
       "user_selector": "...",
       "pass_selector": "...",
       "submit_selector": "..."
     },
     "watch": [...]
   }
   ```

5. **Test thoroughly**

```bash
python3 whistleblower.py --config sites/my-test.json
```

6. **Share it!** Consider opening a PR to add your template to the repository.

---

## Credentials Management

### Option 1: Environment Variables (Recommended)

```json
{
  "login": {
    "username": "${NIAGARA_USERNAME}",
    "password": "${NIAGARA_PASSWORD}",
    ...
  }
}
```

Then set env vars:

```bash
export NIAGARA_USERNAME="ReadOnly"
export NIAGARA_PASSWORD="SecurePassword"
python3 whistleblower.py --config sites/my-site.json
```

### Option 2: .env File

Create `.private/niagara.env`:

```
NIAGARA_USERNAME=ReadOnly
NIAGARA_PASSWORD=SecurePassword
```

Then whistleblower.py will load it automatically (if implemented).

### Option 3: Direct in Config (NOT RECOMMENDED for sensitive data)

```json
{
  "login": {
    "username": "your_username",
    "password": "your_password"
  }
}
```

‚ö†Ô∏è **Never commit credentials to git** - Add `sites/*.json` to `.gitignore` if they contain real credentials.

---

## Testing & Debugging

### Quick Test

```bash
python3 whistleblower.py --config sites/my-site.json --headed
```

### Debug Mode

```bash
python3 whistleblower.py --config sites/my-site.json --headed --timeout-ms 60000
```

### Record Video

```bash
python3 whistleblower.py --config sites/my-site.json --record-video
```

Video saved to: `data/<site_name>/<timestamp>/video/session.mp4`

### Check Output

```bash
ls -la data/<site_name>/
cat data/<site_name>/<timestamp>/target_1/meta.json
```

---

## FAQ

**Q: Can I monitor multiple sites with one template?**
A: Yes! Copy the template multiple times with different configs:

```bash
cp sites/niagara.template.json sites/niagara-building-a.json
cp sites/niagara.template.json sites/niagara-building-b.json
```

**Q: What if the login selectors change between versions?**
A: Use bootstrap_recorder.py to re-discover them, then update the config.

**Q: Can I use pre_click_steps for navigation?**
A: Yes! See `react-click-based.template.json` for examples of using `pre_click_steps`.

**Q: How do I schedule captures?**
A: Use `ui_app.py` (web UI) for simple scheduling, or use your OS scheduler:

- **Linux/macOS**: `crontab -e` and add a cron job
- **Windows**: Task Scheduler with a batch script

**Q: What's the difference between settled_ms and timeout_ms?**

- `settle_ms`: Grace time AFTER page is loaded (for JS to render)
- `timeout_ms`: Max time to wait before giving up

---

## Support & Contributing

Found a new BAS vendor?  
Have a template improvement?  
Open an issue or PR on the [repository](https://github.com/makeitworkok/Whistleblower).

Help us build the most complete BAS vendor template database! üöÄ
